<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–æ–ª—å–∫–≤–∞–Ω–≥ - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º: */
        
        /* –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ */
        .server-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .server-status.connected {
            border-color: #10b981;
            color: #10b981;
        }
        
        .server-status.connecting {
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .server-status.disconnected {
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .connected .status-dot { background: #10b981; animation: pulse 2s infinite; }
        .connecting .status-dot { background: #f59e0b; }
        .disconnected .status-dot { background: #ef4444; }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ */
        .server-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: white;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #10b981;
            z-index: 2000;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideInRight 0.3s ease;
        }
        
        .server-notification.fade-out {
            animation: fadeOutUp 0.3s ease forwards;
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #10b981;
            font-size: 14px;
        }
        
        .notification-content {
            font-size: 13px;
            line-height: 1.4;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOutUp {
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ -->
        <div id="serverStatus" class="server-status disconnected">
            <div class="status-dot"></div>
            <span id="serverStatusText">–°–µ—Ä–≤–µ—Ä: –æ—Ç–∫–ª—é—á–µ–Ω</span>
        </div>
        
        <!-- –í–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞–∫ —Ä–∞–Ω—å—à–µ -->
        <!-- –®–∞–ø–∫–∞, –≤–∫–ª–∞–¥–∫–∏ —ç—Ç–∞–∂–µ–π, –±–æ—Å—Å—ã –∏ —Ç.–¥. -->
        
    </div>

    <script>
        // ===== WebSocket –∫–ª–∏–µ–Ω—Ç –¥–ª—è Render =====
        class RenderServer {
            constructor() {
                this.socket = null;
                this.connected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 3000;
                this.serverUrl = null;
                this.serverDomains = [
                    'wss://folkvang-server.onrender.com',
                    'wss://folkvang-boss-tracker.onrender.com',
                    'ws://localhost:10000'  // –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
                ];
            }
            
            async init() {
                await this.findWorkingServer();
                this.connect();
                this.startHeartbeat();
            }
            
            async findWorkingServer() {
                // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—á–∏–π —Å–µ—Ä–≤–µ—Ä
                for (const url of this.serverDomains) {
                    if (await this.testServer(url)) {
                        this.serverUrl = url;
                        this.updateStatus('connecting', `–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${new URL(url).hostname}`);
                        console.log(`‚úÖ –ù–∞–π–¥–µ–Ω —Å–µ—Ä–≤–µ—Ä: ${url}`);
                        return;
                    }
                }
                
                console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—á–∏–π —Å–µ—Ä–≤–µ—Ä');
                this.serverUrl = null;
                this.updateStatus('disconnected', '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            }
            
            async testServer(url) {
                return new Promise((resolve) => {
                    const testSocket = new WebSocket(url);
                    
                    testSocket.onopen = () => {
                        testSocket.close();
                        resolve(true);
                    };
                    
                    testSocket.onerror = () => {
                        resolve(false);
                    };
                    
                    setTimeout(() => resolve(false), 2000);
                });
            }
            
            connect() {
                if (!this.serverUrl) {
                    console.log('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞');
                    setTimeout(() => this.findWorkingServer(), 10000);
                    return;
                }
                
                try {
                    console.log(`üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${this.serverUrl}`);
                    this.socket = new WebSocket(this.serverUrl);
                    
                    this.socket.onopen = () => {
                        console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                        this.connected = true;
                        this.reconnectAttempts = 0;
                        this.updateStatus('connected', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                        
                        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        setTimeout(() => {
                            if (this.connected && this.socket) {
                                this.socket.send(JSON.stringify({ action: 'get_state' }));
                            }
                        }, 1000);
                    };
                    
                    this.socket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                        }
                    };
                    
                    this.socket.onclose = (event) => {
                        console.log(`‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ: ${event.code} ${event.reason}`);
                        this.connected = false;
                        this.updateStatus('disconnected', '–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                        this.attemptReconnect();
                    };
                    
                    this.socket.onerror = (error) => {
                        console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                        this.updateStatus('disconnected', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                    };
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                    this.attemptReconnect();
                }
            }
            
            handleMessage(data) {
                // console.log('üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                
                if (data.action === 'boss_killed' || data.type === 'boss_update') {
                    this.processKill(data);
                } else if (data.initial_state || data.state_update) {
                    this.syncWithServer(data.initial_state || data.state_update);
                } else if (data.connected) {
                    console.log('–°–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                } else if (data.pong) {
                    // –û—Ç–≤–µ—Ç –Ω–∞ –ø–∏–Ω–≥
                } else if (data.kill_confirmed) {
                    if (data.success) {
                        this.showNotification({
                            title: '‚úÖ –£–±–∏–π—Å—Ç–≤–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ',
                            message: '–í—Å–µ –∏–≥—Ä–æ–∫–∏ –ø–æ–ª—É—á–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'
                        });
                    }
                }
            }
            
            processKill(killData) {
                const bossNames = {
                    'mage': '–í—ë–ª—å–≤–∞',
                    'healer': '–°–∫–∞–ª—å–¥',
                    'spearman': '–ö–æ–ø–µ–π—â–∏–∫',
                    'berserk': '–ë–µ—Ä—Å–µ—Ä–∫'
                };
                
                const floorId = `floor${killData.floor}`;
                const bossType = killData.boss;
                const bossName = bossNames[bossType] || bossType;
                
                if (bossesData[floorId] && bossesData[floorId][bossType]) {
                    const boss = bossesData[floorId][bossType];
                    const killTime = new Date(killData.kill_time).getTime();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ —É–±–∏–π—Å—Ç–≤–æ –Ω–æ–≤–µ–µ
                    if (!boss.lastKill || killTime > boss.lastKill) {
                        boss.lastKill = killTime;
                        saveToLocalStorage();
                        updateBossTimer(floorId, bossType, false);
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–±–∏–π—Å—Ç–≤–æ –Ω–µ –Ω–∞—à–µ)
                        const currentPlayer = tg.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫';
                        if (killData.player !== currentPlayer) {
                            this.showKillNotification(bossName, killData.floor, killData.player);
                        }
                    }
                }
            }
            
            syncWithServer(serverState) {
                console.log('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                
                let updated = false;
                
                Object.keys(serverState).forEach(floorId => {
                    Object.keys(serverState[floorId]).forEach(bossType => {
                        const serverBoss = serverState[floorId][bossType];
                        const localBoss = bossesData[floorId]?.[bossType];
                        
                        if (serverBoss && localBoss && serverBoss.kill_time) {
                            const killTime = new Date(serverBoss.kill_time).getTime();
                            
                            if (!localBoss.lastKill || killTime > localBoss.lastKill) {
                                localBoss.lastKill = killTime;
                                updated = true;
                            }
                        }
                    });
                });
                
                if (updated) {
                    saveToLocalStorage();
                    updateAllTimers();
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
                }
            }
            
            sendKill(floorId, bossType, playerName) {
                if (!this.connected || !this.socket) {
                    console.log('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ');
                    return { success: false, message: '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' };
                }
                
                const floorNum = floorId.replace('floor', '');
                
                const killData = {
                    action: 'boss_kill',
                    floor: parseInt(floorNum),
                    boss: bossType,
                    player: playerName,
                    timestamp: new Date().toISOString()
                };
                
                try {
                    this.socket.send(JSON.stringify(killData));
                    return { success: true, message: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä' };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    return { success: false, message: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏' };
                }
            }
            
            showKillNotification(bossName, floor, player) {
                const notification = document.createElement('div');
                notification.className = 'server-notification';
                notification.innerHTML = `
                    <div class="notification-title">üéØ –ù–û–í–û–ï –£–ë–ò–ô–°–¢–í–û</div>
                    <div class="notification-content">
                        <div><strong>${bossName}</strong></div>
                        <div>–≠—Ç–∞–∂: ${floor}</div>
                        <div>–ò–≥—Ä–æ–∫: ${player}</div>
                        <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                            –¢–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 5000);
            }
            
            showNotification(data) {
                // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                if (tg.showPopup && typeof tg.showPopup === 'function') {
                    tg.showPopup({
                        title: data.title,
                        message: data.message,
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert(`${data.title}\n${data.message}`);
                }
            }
            
            updateStatus(status, text) {
                const element = document.getElementById('serverStatus');
                const textElement = document.getElementById('serverStatusText');
                
                if (element && textElement) {
                    element.className = `server-status ${status}`;
                    textElement.textContent = text;
                }
            }
            
            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    const delay = this.reconnectDelay * this.reconnectAttempts;
                    
                    console.log(`–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${this.reconnectAttempts} —á–µ—Ä–µ–∑ ${delay}–º—Å`);
                    this.updateStatus('connecting', `–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                    
                    setTimeout(() => {
                        this.connect();
                    }, delay);
                } else {
                    console.log('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                    this.updateStatus('disconnected', '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º.');
                    
                    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        this.reconnectAttempts = 0;
                        this.findWorkingServer();
                    }, 30000);
                }
            }
            
            startHeartbeat() {
                // –ü–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                setInterval(() => {
                    if (this.connected && this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({ action: 'ping' }));
                    }
                }, 30000);
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–µ—Ä
        const renderServer = new RenderServer();
        
        // ===== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø markBossKilled =====
        async function markBossKilled() {
            if (!currentBoss) return;
            
            const { floorId, bossType } = currentBoss;
            const boss = bossesData[floorId][bossType];
            const playerName = tg.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫';
            
            // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            boss.lastKill = Date.now();
            saveToLocalStorage();
            
            // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä Render
            const result = renderServer.sendKill(floorId, bossType, playerName);
            
            // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (result.success) {
                showAlert(`‚úÖ ${boss.name} —É–±–∏—Ç!\n–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.\n–í—Å–µ –∏–≥—Ä–æ–∫–∏ —É–≤–∏–¥—è—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!`);
            } else {
                showAlert(`‚úÖ ${boss.name} –æ—Ç–º–µ—á–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ.\n${result.message}\n–ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏ –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è.`);
            }
            
            // 4. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateBossTimer(floorId, bossType, true);
            updateTimersForFloor(floorId);
            
            // 5. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            closeModal();
        }
        
        // ===== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
        function initApp() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            loadFromLocalStorage();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç–∞–π–º–µ—Ä—ã
            updateAllTimers();
            updateLastUpdateTime();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É Render
            renderServer.init();
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤
            setInterval(updateAllTimers, 1000);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤ –ø–æ–¥–≤–∞–ª–µ
            setInterval(updateLastUpdateTime, 30000);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram
            const tg = window.Telegram.WebApp || {};
            if (tg.expand && typeof tg.expand === 'function') {
                tg.expand();
            }
            
            if (tg.platform === 'android' && tg.BackButton && typeof tg.BackButton.show === 'function') {
                tg.BackButton.show();
                tg.BackButton.onClick(() => {
                    if (document.getElementById('bossModal').classList.contains('active')) {
                        closeModal();
                    } else if (tg.close && typeof tg.close === 'function') {
                        tg.close();
                    }
                });
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>